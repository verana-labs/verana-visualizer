name: Continuous Deployment

on:
  push:
    branches: [main, 'release/**']

permissions:
  id-token: write
  contents: write
  issues: write
  pull-requests: write

env:
  IMAGE_NAME: 'verana-visualizer'

jobs:
  resolve-version:
    uses: 2060-io/organization/.github/workflows/resolve-version-call.yml@main

  docker:
    needs: resolve-version
    if: needs.resolve-version.outputs.new-release-published == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - environment: testnet
            chain_id: vna-testnet-1
            chain_name: VeranaTestnet1
          - environment: devnet
            chain_id: vna-devnet-1
            chain_name: VeranaDevnet1

    env:
      RELEASE_TYPE: ${{ needs.resolve-version.outputs.release-type }}
      RELEASE_VERSION: ${{ needs.resolve-version.outputs.release-version }}
      RELEASE_MAJOR: ${{ needs.resolve-version.outputs.release-major }}
      RELEASE_MINOR: ${{ needs.resolve-version.outputs.release-minor }}
      RELEASE_PATCH: ${{ needs.resolve-version.outputs.release-patch }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute tags
        id: compute-tags
        run: |
          if [ "$RELEASE_TYPE" = "stable" ]; then
            echo "IMAGE_TAG=latest" >> $GITHUB_ENV
            echo "SUFFIX=" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=dev" >> $GITHUB_ENV
            echo "SUFFIX=-dev" >> $GITHUB_ENV
            echo "RELEASE_PATCH_SHORT=${RELEASE_PATCH:0:1}" >> $GITHUB_ENV
          fi

      - name: Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_LOGIN }}
          password: ${{ secrets.DOCKER_HUB_PWD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push dev tags
        if: env.RELEASE_TYPE == 'dev'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ secrets.DOCKER_HUB_LOGIN }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}-${{ matrix.environment }}
            ${{ secrets.DOCKER_HUB_LOGIN }}/${{ env.IMAGE_NAME }}:v${{ env.RELEASE_MAJOR }}${{ env.SUFFIX }}-${{ matrix.environment }}
            ${{ secrets.DOCKER_HUB_LOGIN }}/${{ env.IMAGE_NAME }}:v${{ env.RELEASE_MAJOR }}.${{ env.RELEASE_MINOR }}${{ env.SUFFIX }}-${{ matrix.environment }}
            ${{ secrets.DOCKER_HUB_LOGIN }}/${{ env.IMAGE_NAME }}:v${{ env.RELEASE_MAJOR }}.${{ env.RELEASE_MINOR }}.${{ env.RELEASE_PATCH_SHORT }}${{ env.SUFFIX }}-${{ matrix.environment }}
            ${{ secrets.DOCKER_HUB_LOGIN }}/${{ env.IMAGE_NAME }}:${{ env.RELEASE_VERSION }}-${{ matrix.environment }}
          build-args: |
            NEXT_PUBLIC_BASE_URL=https://vis.${{ matrix.environment }}.verana.network
            NEXT_PUBLIC_GITHUB_TOKEN=${{ secrets.TOKEN_GITHUB }}
            NEXT_PUBLIC_API_ENDPOINT=https://api.${{ matrix.environment }}.verana.network
            NEXT_PUBLIC_RPC_ENDPOINT=https://rpc.${{ matrix.environment }}.verana.network
            NEXT_PUBLIC_IDX_ENDPOINT=https://idx.${{ matrix.environment }}.verana.network
            NEXT_PUBLIC_RESOLVER_ENDPOINT=https://resolver.${{ matrix.environment }}.verana.network
            NEXT_PUBLIC_CHAIN_ID=${{ matrix.chain_id }}
            NEXT_PUBLIC_CHAIN_NAME=${{ matrix.chain_name }}
          cache-from: type=gha,scope=${{ matrix.environment }}
          cache-to: type=gha,mode=max,scope=${{ matrix.environment }}

      - name: Build & push stable release tags
        if: env.RELEASE_TYPE == 'stable'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ secrets.DOCKER_HUB_LOGIN }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}-${{ matrix.environment }}
            ${{ secrets.DOCKER_HUB_LOGIN }}/${{ env.IMAGE_NAME }}:v${{ env.RELEASE_MAJOR }}${{ env.SUFFIX }}-${{ matrix.environment }}
            ${{ secrets.DOCKER_HUB_LOGIN }}/${{ env.IMAGE_NAME }}:v${{ env.RELEASE_MAJOR }}.${{ env.RELEASE_MINOR }}${{ env.SUFFIX }}-${{ matrix.environment }}
            ${{ secrets.DOCKER_HUB_LOGIN }}/${{ env.IMAGE_NAME }}:${{ env.RELEASE_VERSION }}-${{ matrix.environment }}
          build-args: |
            NEXT_PUBLIC_BASE_URL=https://vis.${{ matrix.environment }}.verana.network
            NEXT_PUBLIC_GITHUB_TOKEN=${{ secrets.TOKEN_GITHUB }}
            NEXT_PUBLIC_API_ENDPOINT=https://api.${{ matrix.environment }}.verana.network
            NEXT_PUBLIC_RPC_ENDPOINT=https://rpc.${{ matrix.environment }}.verana.network
            NEXT_PUBLIC_IDX_ENDPOINT=https://idx.${{ matrix.environment }}.verana.network
            NEXT_PUBLIC_RESOLVER_ENDPOINT=https://resolver.${{ matrix.environment }}.verana.network
            NEXT_PUBLIC_CHAIN_ID=${{ matrix.chain_id }}
            NEXT_PUBLIC_CHAIN_NAME=${{ matrix.chain_name }}
          cache-from: type=gha,scope=${{ matrix.environment }}
          cache-to: type=gha,mode=max,scope=${{ matrix.environment }}

  helm:
    needs: [resolve-version, docker]
    if: needs.resolve-version.outputs.new-release-published == 'true'
    runs-on: ubuntu-latest
    env:
      RELEASE_TYPE: ${{ needs.resolve-version.outputs.release-type }}
      RELEASE_VERSION: ${{ needs.resolve-version.outputs.release-version }}
      RELEASE_MAJOR: ${{ needs.resolve-version.outputs.release-major }}
      RELEASE_MINOR: ${{ needs.resolve-version.outputs.release-minor }}
      RELEASE_PATCH: ${{ needs.resolve-version.outputs.release-patch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_LOGIN }}
          password: ${{ secrets.DOCKER_HUB_PWD }}

      - name: Push Helm chart to Docker Hub OCI repo
        run: |
          if [ "$RELEASE_TYPE" = "stable" ]; then
            TAGS=("${RELEASE_VERSION}")
          else
            TAGS=(
              "v${RELEASE_MAJOR}.${RELEASE_MINOR}.${RELEASE_PATCH:0:1}-dev"
              "${RELEASE_VERSION}"
            )
          fi
          for tag in "${TAGS[@]}"; do
            CHART_NAME=$(grep '^name:' ./charts/Chart.yaml | awk '{print $2}')
            helm package ./charts --version $tag -d ./charts
            helm push ./charts/${CHART_NAME}-$tag.tgz oci://docker.io/${{ secrets.DOCKER_HUB_LOGIN }}
          done
